# Arch Linux 路由器的 IPv6 实现方案


开启软路由的IPv6功能原本应该非常简单，但是在实际操作中，可能会遇到一些问题，因为IPv6和IPv4的地址分配方式不同，导致一些软件的配置和使用需要特殊处理。

首先，IPv6地址长度为128位，太长了，很难手动配置，所以正常情况下都是自动分配IPv6地址的。

我们先来了解公网IPv6地址是如何配置的，自动分配IPv6地址方式有两种：

|  参数          | DHCPv6（有状态）                         | SLAAC（无状态）                         |
|----------------|------------------------------------------|-----------------------------------------|
| **配置方式**   | 需要DHCPv6服务器分配，主机通过DHCPv6获取地址    | 路由器通过RA广播前缀，主机自动生成地址   |
| **依赖服务**   | 需要DHCPv6服务器（如dnsmasq、dhcpd）      | 只需路由器支持RA（如dnsmasq、radvd）    |
| **地址分配**   | 由服务器集中分配，支持地址管理和分配策略   | 主机根据前缀和自身接口自动生成           |
| **地址记录**   | 服务器可记录所有分配的地址                | 路由器不记录主机分配的地址               |
| **前缀变更适应**| 服务器可灵活下发新前缀                   | 主机自动响应RA变更，自动重组地址         |
| **支持DNS推送**| 支持（可下发DNS信息）                     | 支持（需RA带RDNSS选项，部分主机不支持）  |
| **兼容性**     | 适合企业/大规模网络，便于集中管理         | 适合家庭/小型网络，配置简单              |
| **主机唯一性** | 地址唯一性由服务器保证                    | 需主机自行DAD检测（可能有冲突）          |
| **扩展性**     | 支持更多选项（如租期、静态分配等）         | 仅支持基本前缀和自动地址生成             |
| **易用性**     | 配置复杂，需维护服务器                    | 配置简单，开箱即用                       |
| **常见用途**   | 企业、校园网、需要精细管理的场景           | 家庭、普通办公、无需精细管理的场景        |

**总结：**  
- **SLAAC** 优点是简单、自动、无需服务器，适合大多数家庭和小型网络。
- **DHCPv6** 适合需要集中管理、地址分配可控、需要详细日志和策略的企业/大规模网络。



实践IPv6支持方案：

- 通过`dhcpcd`作为DHCPv6客户端自动获取IPv6-PD前缀（为ppp0和enp0s25 自动分配IPv6地址）。
- 通过`dnsmasq`配置支持`RA`功能，为内网提供SLAAC无状态自动配置IPv6地址。

## Arch Linux 软路由 IPv6 支持方案对比

| 方案                | 主要组件         | 局域网地址分配方式         | 配置难度 | 适用场景           | 优点                                   | 缺点                                   |
|---------------------|------------------|----------------------|----------|--------------------|----------------------------------------|----------------------------------------|
| SLAAC方式(RA广播)  | dhcpcd/dnsmasq  | SLAAC（RA广播） | 简单  | 运营商支持PD的环境  | 自动获取公网前缀  | 大部分运营商支持，配置简单 |
| DHCPv6+SLAAC  | dhcpcd/dnsmasq   | SLAAC（RA广播）+ DHCPv6 | 简单  | 家用/小型办公网络   | 配置简单，主机自动生成IPv6地址方式双选择  |  每个接口会有至少两个公网IPv6地址(ra+dhcp)和一个私有IPv6地址，需要维护IPv6地址分配状态  |


**推荐：**
- 家庭/小规模网络：建议选择**SLAAC(无状态)方式** 实现IPv6支持。
- 企业/大规模网络：建议选择 **DHCPv6（有状态）** 集中管理。


## IPv6相关服务知识

为了方便我们对一些服务有些简单的了解，我们列出一些常见的服务的信息，这些信息对于我们配置软路由的IPv6功能至关重要。


| 服务     | 协议/类型   | 客户端端口  | 服务器端口       | 作用描述            |
| ------ | ------- | ------ | ----------- | --------------- |
| DNS    | UDP/TCP | 任意临时端口 | 53          | 域名解析            |
| DHCP   | UDP     | 68     | 67          | IPv4 动态主机配置协议   |
| DHCPv6 | UDP     | 546    | 547         | IPv6 动态主机配置协议   |
| RA     | ICMPv6  | -      | 类型 134      | 路由器通告（用于 SLAAC） |
| NDP    | ICMPv6  | -      | 类型 135\~136 | 邻居发现（请求/通告）     |
| SLAAC  | ICMPv6  | -      | 类型 134      | 无状态地址自动配置       |

## IPv6地址分配原理

公网IPv6地址的分配方法：
- DHCPv6自动分配： 这类似DHCPv4，但是分配的是前缀，而不是具体的IP地址。
- SLAAC（无状态地址自动配置）：主机通过ICMPv6协议自动获取地址，无需DHCP服务器。



## NDP协议知识


**NDP 是一个协议框架**，其中包含 **RA（Router Advertisement）** 和 **SLAAC（Stateless Address Autoconfiguration）** 机制，用于实现 IPv6 地址分配、邻居发现、路由信息传递等功能。


### 🧱 一、NDP（Neighbor Discovery Protocol）邻居发现协议

* **定义**：NDP 是 IPv6 中用来替代 ARP、ICMP 重定向、ICMP Router Discovery 等 IPv4 协议功能的综合协议。
* **协议类型**：使用 **ICMPv6** 报文。
* **工作原理**：

  * 工作在链路层（L2），通过多播方式通信。
  * 使用以下 ICMPv6 报文类型：

    | 功能                          | ICMPv6 类型 | 说明                 |
    | --------------------------- | --------- | ------------------ |
    | Router Solicitation (RS)    | 133       | 主机请求路由器发送 RA       |
    | Router Advertisement (RA)   | 134       | 路由器发送前缀信息、MTU 等    |
    | Neighbor Solicitation (NS)  | 135       | 查询某个地址对应的 MAC 地址   |
    | Neighbor Advertisement (NA) | 136       | 响应 NS，请求者得知 MAC 地址 |
    | Redirect                    | 137       | 告知主机更好的下一跳         |


### 📡 二、RA（Router Advertisement）路由器通告

* **属于 NDP 的一部分**（ICMPv6 类型 134）。
* **作用**：

  * 路由器定期或响应 RS 请求时发送 RA。
  * **携带配置信息**，比如：

    * 网络前缀（例如：`2001:db8::/64`）
    * 链路 MTU
    * 默认网关地址
    * **标志位：M（Managed）和 O（Other）**，用于指导是否使用 DHCPv6
    * 自动配置标志（A-bit）用于启用 SLAAC。
* **广播地址**：`ff02::1`（所有节点）


### 🧠 三、SLAAC（Stateless Address Autoconfiguration）无状态地址自动配置

* **基于 RA 的机制**：依赖路由器发送的前缀信息。
* **流程**：

  1. 主机收到 **RA 报文**。
  2. 提取网络前缀（如 `2001:db8::/64`）。
  3. 使用本地接口标识（如 MAC 地址）生成剩余位（例如使用 EUI-64 或随机生成）。
  4. 合并为完整 IPv6 地址（如：`2001:db8::abcd:ef12:3456:7890`）。
  5. 进行 DAD（重复地址检测）确认地址唯一性。


### 🧭 关系总结

| 项目    | 类型/机制          | 依赖谁？       | 提供什么？            |
| ----- | -------------- | ---------- | ---------------- |
| NDP   | 协议框架           | -          | 邻居发现、路由器发现、地址解析  |
| RA    | ICMPv6 报文（134） | NDP        | 发送网络前缀、自动配置信息    |
| SLAAC | 地址配置机制         | RA（来自 NDP） | 基于前缀自动生成 IPv6 地址 |

---

### 🧩 举个例子（主机首次上线）：

1. 主机上线后，发送 **RS（Router Solicitation）** 到 `ff02::2`（所有路由器）。
2. 路由器回应一个 **RA（Router Advertisement）** 报文。
3. 主机从 RA 获取：

   * IPv6 前缀
   * DNS（可选）
   * SLAAC 是否可用（通过 RA 中的 A-bit）
4. 主机使用 **SLAAC** 构造一个完整 IPv6 地址。
5. 主机用 **NS/NA（NDP 的部分）** 进行重复地址检测（DAD）。

